<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Dice Poker</title>
      <style>
         /* ===== Theme palette (pastel / cozy) ===== */
         :root{
           --bg-sky:#dff4ff;
           --bg:#f7f3ee;
           --panel:#fff8f0;
           --edge:#e6dccb;
           --text:#4a3f2f;
           --muted:#9b8c75;
           --accent:#7fd1b8;
           --ok:#91b36f;
           --warn:#e2a55f;
           --bad:#d97b7b;
           --spade:#5c89d3;
           --club:#70b36f;
           --heart:#e8706c;
           --diamond:#f4aa62;
           --paper-cream:#fffaf0;
           --paper-shadow: rgba(60,40,20,0.06);
         }

         *{box-sizing:border-box}
         html,body{height:100%}
         body{
           margin:0;
           font-family: "Nunito", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
           background: linear-gradient(180deg,var(--bg-sky) 0%, var(--bg) 60%);
           color:var(--text);
           position:relative;
           -webkit-font-smoothing:antialiased;
           -moz-osx-font-smoothing:grayscale;
         }

         /* ===== Background illustration (static) ===== */
         .background{
           position:fixed;
           inset:0;
           z-index:-1;
           pointer-events:none;
           overflow:hidden;
         }
         .background svg{width:100%;height:100%;display:block}

         .wrap{max-width:1200px;margin:0 auto;padding:20px 18px 36px}
         header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
         header h1{font-size:22px;margin:0;letter-spacing:.3px;color:var(--text)}
         header .sub{font-size:12px;color:var(--muted)}

         .grid{display:grid;grid-template-columns:280px 1fr 360px;gap:16px}
         .panel{
           background:var(--panel);
           border:1.5px solid var(--edge);
           border-radius:16px;
           padding:14px;
           box-shadow:0 8px 20px rgba(40,30,20,0.06);
         }

         h2{font-size:15px;margin:0 0 10px 0;color:var(--text);letter-spacing:.2px}
         h3{font-size:13px;margin:10px 0 6px 0;color:var(--text)}
         .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

         /* Controls */
         .controls button,.controls select,.controls input[type="number"],.controls input[type="text"]{
           background:var(--paper-cream);
           border:1px solid var(--edge);
           color:var(--text);
           padding:8px 10px;
           border-radius:10px;
           cursor:pointer;
           font-size:13px;
           box-shadow:0 2px 6px var(--paper-shadow);
         }
         .controls button:hover{transform:translateY(-1px)}
         .controls .primary{
           background:linear-gradient(180deg,var(--accent),#5db79f);
           border-color:#5da78f;
           color:#ffffff;
           font-weight:700;
         }
         .controls .ghost{background:transparent}

         .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--edge);background:var(--paper-cream);font-size:12px;color:var(--muted);font-weight:600}

         .piles{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
         .pile{
           background:linear-gradient(180deg,#fffdfa,#fff6ec);
           border:1.5px solid var(--edge);
           border-radius:14px;padding:10px;min-height:118px;
           position:relative;overflow:hidden;
           box-shadow:0 4px 10px rgba(40,30,20,0.04);
         }
         .pile .label{position:absolute;top:8px;left:10px;font-size:11px;color:var(--muted)}
         .pile .top{margin-top:22px;display:flex;align-items:center;justify-content:center;gap:6px;min-height:72px}
         .pile .count{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}

         /* ===== Card: paper style ===== */
         .card{
           display:inline-grid;
           place-items:center;
           width:56px;
           height:80px;
           border-radius:14px;
           border:1px solid rgba(0,0,0,0.06);
           background:linear-gradient(180deg,var(--paper-cream),#fff4e6);
           font-weight:800;
           position:relative;
           user-select:none;
           box-shadow:0 8px 18px rgba(30,20,10,0.06);
           transform-origin:center;
           transition:transform 0.14s ease, box-shadow 0.14s ease, outline 0.14s ease;
           padding:6px;
         }

         /* subtle paper texture using before */
         .card::before{
           content:"";
           position:absolute;
           inset:0;
           border-radius:12px;
           background-image:
             radial-gradient(circle at 10% 10%, rgba(255,255,255,0.5) 0px, rgba(255,255,255,0) 10px),
             linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
           pointer-events:none;
           mix-blend-mode:soft-light;
         }

         .card:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(30,20,10,0.09)}
         .card.sel{outline:3px solid rgba(127,209,184,0.6);outline-offset:2px}

         .card .r{font-size:18px;line-height:1;color:var(--text);position:absolute;top:8px;left:8px}
         .card .s{font-size:18px;line-height:1;color:var(--text);position:absolute;bottom:10px;right:10px;transform:translateY(-2px)}

         /* Suit color tints (kept on small elements too) */
         .s-spade{color:#222f45}
         .s-spade .s{color:var(--spade)}
         .s-club{color:#223925}
         .s-club .s{color:var(--club)}
         .s-heart{color:#3b1f24}
         .s-heart .s{color:var(--heart)}
         .s-diamond{color:#4a2d13}
         .s-diamond .s{color:var(--diamond)}

         .placeholder{opacity:.45;border-style:dashed;background:linear-gradient(180deg,#fffaf0,#fff6ea)}
         .hand{display:flex;flex-wrap:wrap;gap:10px;min-height:88px}
         .info{font-size:13px;color:var(--muted)}
         .score{font-size:13px}
         .log{max-height:260px;overflow:auto;font-size:13px;border-radius:10px;background:linear-gradient(180deg,#fffdfa,#fff6ec);padding:10px;border:1.5px solid var(--edge)}
         .log p{margin:6px 0}
         .muted{color:var(--muted)}
         .good{color:var(--ok)}
         .warn{color:var(--warn)}
         .bad{color:var(--bad)}

         .footer{margin-top:16px;font-size:12px;color:var(--muted)}
         details{border-top:1px solid var(--edge);margin-top:10px;padding-top:10px}
         table{width:100%;border-collapse:collapse;font-size:13px}
         th,td{border-bottom:1px solid var(--edge);padding:8px;text-align:left}
         code.kbd{padding:2px 8px;border-radius:6px;background:#fffdf6;border:1px solid var(--edge)}
         a{color:var(--accent)}

         @media(max-width:1024px){.grid{grid-template-columns:1fr}}

         /* Dice -- keep original transforms but restyle faces */
         .dice-area{display:flex;align-items:center;gap:10px}
         .dice-wrap{width:62px;height:62px;perspective:700px}
         .dice{width:62px;height:62px;position:relative;transform-style:preserve-3d;transition:transform 700ms cubic-bezier(.2,.8,.2,1)}
         .dice.rolling{animation:roll-spin 650ms ease-in-out}
         @keyframes roll-spin{0%{transform:rotateX(0) rotateY(0)}50%{transform:rotateX(200deg) rotateY(160deg)}100%{transform:rotateX(360deg) rotateY(360deg)}}
         .dice .side{position:absolute;width:62px;height:62px;border-radius:14px;background:linear-gradient(180deg,#fffaf0,#fff5e8);color:var(--text);border:2px solid var(--edge);display:grid;place-items:center;font-weight:800;font-size:20px;box-shadow:inset 0 2px 0 rgba(255,255,255,0.6)}
         .side.front{transform:translateZ(31px)}
         .side.back{transform:rotateY(180deg) translateZ(31px)}
         .side.right{transform:rotateY(90deg) translateZ(31px)}
         .side.left{transform:rotateY(-90deg) translateZ(31px)}
         .side.top{transform:rotateX(90deg) translateZ(31px)}
         .side.bottom{transform:rotateX(-90deg) translateZ(31px)}

         /* flying card animation */
         .fly{position:fixed;z-index:50;transition:transform 600ms cubic-bezier(.22,1,.36,1), opacity 600ms ease;will-change:transform,opacity}
      </style>
   </head>
   <body>
      <!-- Static illustrated background (hills + clouds) -->
      <div class="background" aria-hidden="true">
        <svg viewBox="0 0 1600 900" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg" role="img">
          <defs>
            <linearGradient id="sky" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0" stop-color="#dff4ff"/>
              <stop offset="1" stop-color="#f7f3ee"/>
            </linearGradient>
            <filter id="soft" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="30" result="b"/>
              <feBlend in="SourceGraphic" in2="b" mode="normal"/>
            </filter>
          </defs>
          <rect width="1600" height="900" fill="url(#sky)"/>
          <!-- distant soft clouds -->
          <g opacity="0.75" filter="url(#soft)" transform="translate(60,30)">
            <ellipse cx="360" cy="80" rx="140" ry="40" fill="#ffffff" opacity="0.6"/>
            <ellipse cx="600" cy="70" rx="180" ry="50" fill="#ffffff" opacity="0.55"/>
            <ellipse cx="1100" cy="90" rx="150" ry="45" fill="#ffffff" opacity="0.5"/>
          </g>
          <!-- hills -->
          <path d="M0 720 Q300 620 800 700 T1600 700 L1600 900 L0 900 Z" fill="#bfe3b5"/>
          <path d="M0 760 Q300 680 800 760 T1600 760 L1600 900 L0 900 Z" fill="#a8d497"/>
          <path d="M0 800 Q300 730 800 800 T1600 800 L1600 900 L0 900 Z" fill="#8fbd8f"/>
        </svg>
      </div>

      <div class="wrap">
         <header>
            <div>
               <h1>Dice Poker</h1>
               <div class="sub">Solo version - <a href = "https://gamedesignbites.substack.com"> Game Design Bites</a> x GPT5 </div>
            </div>
            <div class="controls row">
               <button class="primary" id="newGame">New Game</button>
            </div>
         </header>
         <div class="grid">
            <!-- Left: Settings (collapsed by default) -->
            <section class="panel">
               <details id="settings">
                  <summary style="font-size:14px;color:var(--text);cursor:pointer">Settings</summary>
                  <div style="margin-top:10px">
                     <div class="info">Edit multipliers before you play a hand.</div>
                     <div id="multTable" style="margin-top:8px"></div>
                     <details style="margin-top:8px">
                        <summary>Advanced</summary>
                        <div class="row" style="margin-top:8px">
                           <label class="pill">Seed</label>
                           <input id="seed" type="text" placeholder="optional" />
                           <button id="reshuffle">Reshuffle</button>
                        </div>
                        <div class="info" style="margin-top:6px">Seeded shuffles help test and share setups.</div>
                     </details>
                  </div>
               </details>
               <h2 style="margin-top:10px">RULES:</h2>
                <div class="info">
                  <ul style="margin:8px 0 0 18px">
                    <li>🃏 <span style="color:#e8706c">6 piles of cards</span>: 7 face-down + 1 face-up each.</li>
                    <li>✋ Start with <span style="color:#7fd1b8">4 cards</span> in your hand.</li>
                    <li>🎲 Roll the dice to take the top card from the matching pile.</li>
                    <li>🔄 Up to <span style="color:#e2a55f">3 rolls</span> per round. Empty pile = roll wasted.</li>
                    <li>🖐️ Hand limit: <span style="color:#f4aa62">7 cards</span>. Play a hand before rolling again if full.</li>
                    <li>✅ Select up to <span style="color:#7fd1b8">5 cards</span> and click <em>Play Selected</em> to play a hand.</li>
                    <li>🏆 Score hands using <span style="color:#e8706c">Poker ranks</span>. Only valid combos count; extras are discarded.</li>
                    <li>🎯 Play <span style="color:#e2a55f">15 hands</span>. Final score = sum of all hand scores.</li>
                  </ul>
                </div>
            </section>
            <!-- Middle: Board -->
            <section class="panel">
               <h2>Board</h2>
               <div class="piles" id="piles"></div>
               <div class="controls row" style="margin-top:10px;justify-content:space-between">
                  <div class="row dice-area">
                     <button id="roll" class="primary">🎲 Roll</button>
                     <div class="dice-wrap">
                        <div id="dice" class="dice">
                           <div class="side front">1</div>
                           <div class="side back">6</div>
                           <div class="side right">3</div>
                           <div class="side left">4</div>
                           <div class="side top">5</div>
                           <div class="side bottom">2</div>
                        </div>
                     </div>
                     <span class="pill" id="dieFace">Die: –</span>
                  </div>
                  <div class="row">
                     <span class="pill" id="rollsLeft">Rolls left: 3</span>
                     <span class="pill" id="turnInfo">Solo Round</span>
                  </div>
               </div>
               <h3 style="margin-top:10px">Current Hand</h3>
               <div class="hand" id="hand"></div>
               <div class="controls row" style="margin-top:8px">
                  <button id="play">Play Selected</button>
                  <span class="pill" id="handCap">Hand: 0/7</span>
               </div>
               <div class="score" id="lastScore" style="margin-top:8px"></div>
            </section>
            <!-- Right: Score, Log, High Scores -->
            <section class="panel">
               <h2>Scoreboard</h2>
               <div id="scoreboard"></div>
               <h3>Log</h3>
               <div class="log" id="log"></div>
               <h3 style="margin-top:10px">High Scores (Solo)</h3>
               <div id="highscores">
                  <div id="soloList" class="info" style="margin:6px 0 10px"></div>
                  <button id="clearScores" class="ghost">Clear High Scores</button>
               </div>
            </section>
         </div>
      </div>

      <script>
         // ===== Constants =====
         const SUITS=["♠","♥","♦","♣"]; const RANKS=["2","3","4","5","6","7","8","9","10","J","Q","K","A"]; const RVAL=Object.fromEntries(RANKS.map((r,i)=>[r,i+2]));
         const CARD_POINTS = r => r==="A"?11: ["J","Q","K"].includes(r)?10: parseInt(r);
         const mulDefaults={"High Card":1,"Pair":2,"Two Pair":3,"Three of a Kind":4,"Straight":5,"Flush":6,"Full House":7,"Four of a Kind":8,"Straight Flush":10,"Royal Flush":12};
         
         // Dice orientation (front=1, right=3, left=4, back=6, top=5, bottom=2)
         const ROT_FOR_NUM={
           1:"rotateX(0deg) rotateY(0deg)",
           2:"rotateX(90deg) rotateY(0deg)",
           3:"rotateX(0deg) rotateY(-90deg)",
           4:"rotateX(0deg) rotateY(90deg)",
           5:"rotateX(-90deg) rotateY(0deg)",
           6:"rotateX(0deg) rotateY(180deg)",
         };
         
         // High score storage key (solo only)
         const HS_SOLO='cdp:scores:solo';
         
         // ===== Helpers =====
         function rng(seed){let x=seed||(Math.random()*1e9>>>0);return()=>{x^=x<<13;x^=x>>>17;x^=x<<5;return((x>>>0)%1_000_000)/1_000_000;};}
         function shuffle(a,seed){const r=seed?rng(seed):Math.random;for(let i=a.length-1;i>0;i--){const j=Math.floor((seed?r():r())*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
         function newDeck(){let id=0;return SUITS.flatMap(s=>RANKS.map(r=>({id:id++,rank:r,suit:s})));}

         // ===== State & Setup =====
         let state;
         function dealPiles(deck){const piles=Array.from({length:6},()=>({cards:[],faceDown:0,top:null}));for(let p=0;p<6;p++){const stack=deck.splice(0,8);piles[p].cards=stack;piles[p].faceDown=7;piles[p].top=stack[7]||null;}return piles;}
         function setupGame(){const mode='solo';const seedStr=document.getElementById('seed')?.value?.trim()||"";const seed=seedStr?[...seedStr].reduce((a,c)=>a+c.charCodeAt(0),0):null;const deck=shuffle(newDeck(),seed);const piles=dealPiles(deck);const players=[{name:'Solo',hand:deck.splice(0,4),score:0,handsPlayed:0}] ;return{mode,piles,players,turn:0,rollsLeft:3,die:null,selected:new Set(),log:[],multipliers:{...mulDefaults},finished:false,isAnimating:false};}
         
         // ===== Rendering =====
         function el(html){const d=document.createElement('div');d.innerHTML=html.trim();return d.firstChild;}
         function render(){renderSettings();renderPiles();renderHand();renderHUD();renderScore();renderLog();renderHighScores();}
         function renderSettings(){const box=document.getElementById('multTable');box.innerHTML='';const tbl=document.createElement('table');tbl.appendChild(el('<tr><th>Hand</th><th>Multiplier</th></tr>'));for(const [k,v] of Object.entries(state.multipliers)){const tr=document.createElement('tr');tr.innerHTML=`<td>${k}</td><td><input type="number" min="1" step="1" value="${v}" data-key="${k}" style="width:80px;background:var(--paper-cream);border:1px solid var(--edge);color:var(--text);padding:6px;border-radius:8px"></td>`;tbl.appendChild(tr);}box.appendChild(tbl);box.querySelectorAll('input').forEach(inp=>inp.addEventListener('input',e=>{const k=e.target.dataset.key;state.multipliers[k]=parseInt(e.target.value||'1');}));}
         function suitCls(s){return s==='♠'?'s-spade':s==='♣'?'s-club':s==='♥'?'s-heart':'s-diamond';}
         function cardHtml(c,selectable=true){const sel=state.selected.has(c.id)?' sel':'';return `<div class="card ${suitCls(c.suit)}${sel}" data-id="${c.id}" ${selectable?'':'style="opacity:.8"'}><div class="r">${c.rank}</div><div class="s">${c.suit}</div></div>`}
         function renderPiles(){const root=document.getElementById('piles');root.innerHTML='';state.piles.forEach((p,idx)=>{const top=p.top?cardHtml(p.top,false):`<div class="card placeholder"></div>`;const pile=el(`<div class="pile" data-idx="${idx}"><div class="label">Pile ${idx+1}</div><div class="top">${top}</div><div class="count">Face-down: ${p.faceDown} · Total left: ${p.cards.length}</div></div>`);root.appendChild(pile);});}
         function renderHand(){const root=document.getElementById('hand');root.innerHTML='';const me=state.players[state.turn];me.hand.forEach(c=>root.appendChild(el(cardHtml(c))));root.querySelectorAll('.card').forEach(div=>div.addEventListener('click',()=>{const id=parseInt(div.dataset.id);if(state.selected.has(id))state.selected.delete(id);else state.selected.add(id);renderHand();renderHUD();}));}
         function renderHUD(){
           try{document.getElementById('rollsLeft').textContent=`Rolls left: ${state.rollsLeft}`;}catch(e){}
           try{document.getElementById('dieFace').textContent=`Die: ${state.die??'–'}`}catch(e){}
           const me = state.players[state.turn];
           const cap = 7;
           try{document.getElementById('handCap').textContent=`Hand: ${me.hand.length}/${cap}`}catch(e){}
           try{document.getElementById('turnInfo').textContent='Solo Round'}catch(e){}
         
           const rollBtn = document.getElementById('roll');
           if(rollBtn){
             rollBtn.disabled = state.finished || state.rollsLeft<=0 || me.hand.length>=cap || state.isAnimating;
             if(rollBtn.disabled){
               // visually grey out when disabled
               rollBtn.style.opacity = '0.5';
               rollBtn.style.background = 'linear-gradient(180deg,#efe8df,#e6ded1)';
               rollBtn.style.borderColor = '#e2d8c6';
               rollBtn.style.color = '#a49b8c';
               // add a single log entry when rolls are depleted
               if(state.rollsLeft<=0){
                 const last = state.log[state.log.length-1];
                 if(!last || last.t !== 'No rolls remaining. Play a hand first'){
                   // exact message requested
                   log('No rolls remaining. Play a hand first','warn');
                 }
               }
             } else {
               // restore styles when enabled
               rollBtn.style.opacity = '';
               rollBtn.style.background = '';
               rollBtn.style.borderColor = '';
               rollBtn.style.color = '';
             }
           }
         
           const playBtn=document.getElementById('play'); if(playBtn) playBtn.disabled=state.finished||state.selected.size===0||state.isAnimating;
         }
         function renderScore(){const root=document.getElementById('scoreboard');const p=state.players[0];root.innerHTML=`<p><span class="pill">${p.name}</span> — <strong>${p.score}</strong> pts · Hands: ${p.handsPlayed}</p>`+(state.finished?`<p class="good"><strong>Game Over.</strong> ${winnerText()}</p>`:'');}
         function renderLog(){
           const root = document.getElementById('log');
           // show newest entries at the top
           const entries = state.log.slice(-120).reverse();
           root.innerHTML = entries.map(x=>`<p class="${x.kind||''}">${x.t}</p>`).join('');
         }
         function renderHighScores(){const solo=loadScores(HS_SOLO);const fmt=list=>list.length?'<ol>'+list.map((e,i)=>`<li>#${i+1} — <strong>${e.score}</strong> pts <span class="muted">${e.label?('· '+e.label):''}</span></li>`).join('')+'</ol>':'<div class="muted">No scores yet.</div>';const elSolo=document.getElementById('soloList'); if(elSolo) elSolo.innerHTML=fmt(solo);} 
         function log(t,kind=""){state.log.push({t,kind});renderLog();}
         
         // ===== Dice visual =====
         function setDieVisual(n){const d=document.getElementById('dice');if(!d) return; d.classList.remove('rolling');void d.offsetWidth;d.classList.add('rolling');setTimeout(()=>{d.style.transform=ROT_FOR_NUM[n];},50);} // quick spin then settle
         
         // ===== Draw & animation =====
         function getElementRect(el){const r=el.getBoundingClientRect();return {x:r.left,y:r.top,w:r.width,h:r.height};}
         function flyCardFromTo(card, fromEl, toEl){return new Promise(resolve=>{const fr=getElementRect(fromEl);const tr=getElementRect(toEl);const ghost=document.createElement('div');ghost.className='card '+suitCls(card.suit)+' fly';ghost.innerHTML=`<div class="r">${card.rank}</div><div class="s">${card.suit}</div>`;ghost.style.left=fr.x+'px';ghost.style.top=fr.y+'px';ghost.style.width=fr.w+'px';ghost.style.height=fr.h+'px';document.body.appendChild(ghost);const dx=(tr.x+tr.w/2)-(fr.x+fr.w/2);const dy=(tr.y+tr.h/2)-(fr.y+fr.h/2);requestAnimationFrame(()=>{ghost.style.transform=`translate(${dx}px, ${dy}px)`;ghost.style.opacity='0.9';});setTimeout(()=>{ghost.remove();resolve();},620);});}
         
         async function drawFromPileAnimated(idx){const p=state.piles[idx];if(!p||p.cards.length===0){log(`Rolled ${idx+1} → pile empty.`,`warn`);return false;}const me=state.players[state.turn];const cap=7;if(me.hand.length>=cap){log(`Hand is at cap; cannot draw.`,`bad`);return false;}
           const card=p.cards[p.cards.length-1]; // peek top
           const pileEl=document.querySelector(`.pile[data-idx="${idx}"] .top .card`);
           if(!pileEl){ // fallback: no visual, just delay
             await new Promise(r=>setTimeout(r,1000));
           } else {
             // 1s delay after roll, then animate
             await new Promise(r=>setTimeout(r,1000));
             pileEl.style.visibility='hidden';
             await flyCardFromTo(card, pileEl, document.getElementById('hand'));
           }
           // commit draw
           p.cards.pop();
           if(p.faceDown>0){p.faceDown--;}
           p.top=p.cards[p.cards.length-1]||null;
           me.hand.push(card);
           log(`Drew ${card.rank}${card.suit} from Pile ${idx+1}.`);
           renderPiles();
           renderHand();
           renderHUD();
           return true;
         }
         
         // ===== Game flow =====
         async function rollDie(){const me=state.players[state.turn];const cap=7;if(state.rollsLeft<=0||me.hand.length>=cap||state.finished||state.isAnimating) return;state.isAnimating=true;renderHUD();const face=1+Math.floor(Math.random()*6);state.die=face;state.rollsLeft--;setDieVisual(face);try{document.getElementById('dieFace').textContent=`Die: ${face}`}catch(e){};await drawFromPileAnimated(face-1);state.isAnimating=false;renderHUD();}
         function nextTurn(){state.selected.clear();state.rollsLeft=3;state.die=null;renderHUD();render();}
         function idsToCards(ids,hand){const m=new Map(hand.map(c=>[c.id,c]));return[...ids].map(id=>m.get(id)).filter(Boolean);}
         
         // ===== Hand evaluation =====
         function evaluateBestFromSelected(cards){if(cards.length===0)return null;const byRank=new Map(), bySuit=new Map();for(const c of cards){byRank.set(c.rank,(byRank.get(c.rank)||0)+1);bySuit.set(c.suit,(bySuit.get(c.suit)||[]).concat(c));}
           function sum(cs){return cs.reduce((a,c)=>a+CARD_POINTS(c.rank),0);}  
           function findStraightNums(nums){if(nums.length<5)return null;const a=[...new Set(nums)].sort((x,y)=>x-y);const hasA=a.includes(14);const b=hasA?[1,...a]:a;for(let i=b.length-1;i>=4;i--){const win=b.slice(i-4,i+1);if(win[4]-win[0]===4&&new Set(win).size===5)return win;}return null;}
           function straightFrom(cs){const nums=[...new Set(cs.map(c=>RVAL[c.rank]))].sort((a,b)=>a-b);const seq=findStraightNums(nums);if(!seq)return null;const chosen=[];for(const n of seq){const r=n===1?'A':RANKS[n-2];const pick=cs.find(x=>x.rank===r&&!chosen.includes(x));chosen.push(pick);}return chosen;}
           // Straight Flush / Royal Flush
           function straightFlush(){for(const [s,cs] of bySuit){if(cs.length>=5){const ch=straightFrom(cs);if(ch){const isRoyal=ch.some(c=>c.rank==='A') && ch.some(c=>c.rank==='10');return {name:isRoyal?'Royal Flush':'Straight Flush',cards:ch,base:sum(ch)};}}}return null;}
           // Multiples
           function byRankGroups(){const arr=[...byRank.entries()].sort((a,b)=>b[1]-a[1]||RVAL[b[0]]-RVAL[a[0]]);const g={four:[],three:[],pair:[],single:[]};for(const [r,c] of arr){if(c===4)g.four.push(r);else if(c===3)g.three.push(r);else if(c===2)g.pair.push(r);else g.single.push(r);}return g;}
           function fourKind(){const g=byRankGroups();if(g.four.length){const r=g.four[0];const ch=cards.filter(c=>c.rank===r).slice(0,4);return {name:'Four of a Kind',cards:ch,base:sum(ch)};}return null;}
           function fullHouse(){const g=byRankGroups();if(g.three.length&&(g.pair.length||g.three.length>=2)){const r3=g.three[0];const r2=g.pair[0]||g.three[1];const ch=cards.filter(c=>c.rank===r3).slice(0,3).concat(cards.filter(c=>c.rank===r2).slice(0,2));return {name:'Full House',cards:ch,base:sum(ch)};}return null;}
           function flush(){for(const [s,cs] of bySuit){if(cs.length>=5){const ch=cs.slice().sort((a,b)=>RVAL[b.rank]-RVAL[a.rank]).slice(0,5);return {name:'Flush',cards:ch,base:sum(ch)};}}return null;}
           function straight(){const ch=straightFrom(cards);return ch?{name:'Straight',cards:ch,base:sum(ch)}:null;}
           function three(){const g=byRankGroups();if(g.three.length){const r=g.three[0];const ch=cards.filter(c=>c.rank===r).slice(0,3);return {name:'Three of a Kind',cards:ch,base:sum(ch)};}return null;}
           function twoPair(){const g=byRankGroups();if(g.pair.length>=2){const [r1,r2]=g.pair;const ch=cards.filter(c=>c.rank===r1).slice(0,2).concat(cards.filter(c=>c.rank===r2).slice(0,2));return {name:'Two Pair',cards:ch,base:sum(ch)};}return null;}
           function pair(){const g=byRankGroups();if(g.pair.length){const r=g.pair[0];const ch=cards.filter(c=>c.rank===r).slice(0,2);return {name:'Pair',cards:ch,base:sum(ch)};}return null;}
           function high(){const c=cards.slice().sort((a,b)=>RVAL[b.rank]-RVAL[a.rank])[0];return {name:'High Card',cards:[c],base:sum([c])};}
           return straightFlush()||fourKind()||fullHouse()||flush()||straight()||three()||twoPair()||pair()||high();
         }
         
         function playSelected(){const me=state.players[state.turn];const sel=idsToCards(state.selected,me.hand);if(sel.length===0)return; if(sel.length>5){log('Select at most 5 cards to play.','bad');return;}const best=evaluateBestFromSelected(sel);const mult=state.multipliers[best.name]||1;const contributing=new Set(best.cards.map(c=>c.id));const base=best.base;const score=base*mult;me.hand=me.hand.filter(c=>!state.selected.has(c.id));me.score+=score;me.handsPlayed++;const throwaways=sel.filter(c=>!contributing.has(c.id));log(`${me.name} played ${best.name} for ${base} × ${mult} = ${score}. Discarded ${throwaways.length} extra.`,'good');try{document.getElementById('lastScore').textContent=`${best.name}: ${base} × ${mult} = ${score}`}catch(e){};state.selected.clear();checkEndThenAdvance();}
         
         // ===== End conditions & High Scores =====
         function winnerText(){return `Total: ${state.players[0].score} pts.`}
         function checkEndThenAdvance(){if(state.players[0].handsPlayed>=15){state.finished=true;saveScoresOnFinish();render();return;}nextTurn();}
         
         function loadScores(key){try{return JSON.parse(localStorage.getItem(key))||[]}catch(e){return[]}}
         function persistScores(key,arr){localStorage.setItem(key,JSON.stringify(arr));}
         function pushScore(key,entry){const list=loadScores(key);list.push(entry);list.sort((a,b)=>b.score-a.score);persistScores(key,list.slice(0,10));}
         function saveScoresOnFinish(){pushScore(HS_SOLO,{score:state.players[0].score,label:new Date().toLocaleDateString()});renderHighScores();}
         
         // ===== Wiring =====
         function bind(){const rollBtn=document.getElementById('roll'); if(rollBtn) rollBtn.onclick=rollDie; const playBtn=document.getElementById('play'); if(playBtn) playBtn.onclick=playSelected; const newG=document.getElementById('newGame'); if(newG) newG.onclick=()=>{state=setupGame();render();}; const reshuffle=document.getElementById('reshuffle'); if(reshuffle) reshuffle.onclick=()=>{state=setupGame();render();}; const clearBtn=document.getElementById('clearScores'); if(clearBtn) clearBtn.onclick=()=>{if(confirm('Clear all Solo high scores?')){persistScores(HS_SOLO,[]);renderHighScores();}} }
         
         bind(); state=setupGame(); render();
         // Initialize dice pose
         setTimeout(()=>{const d=document.getElementById('dice'); if(d) d.style.transform=ROT_FOR_NUM[1];},0);
      </script>
   </body>
</html>
